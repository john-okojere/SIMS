{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Include Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
    .d-flex{
        gap: 1rem;
        flex-wrap: wrap;

    }
</style>
<img class="img-fluid" src="{% static 'img/hq.jpg' %}" alt="">
<div class="my-3">
    <hr>
<h1>Welcome to the Student Information Management System (SIMS) Dashboard</h1>
    <p class="text-muted">This is your dashboard where you can navigate to various sections of the system.</p>
</div>
</div>
<!-- User-Specific Dashboard Buttons -->
{% if user.is_authenticated %}
<div class="dashboard-container container" style="display: flex; flex-wrap: wrap; gap: 20px;">
    {% if user.is_staff %}
        <!-- Admin Section -->
        <div class="dashboard-box">
            <h3 class="card-title"> Welcome, {{ request.user.username }} to Admin Dashboard</h3><hr>
            <div class = "d-flex">
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View the complete list of students and their details.</p>
                <a href="{% url 'student_list' %}" class="btn btn-primary">View All Students</a>
            </div>
            
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>Manage courses, update details, and add new ones.</p>
                <a href="{% url 'course_list' %}" class="btn btn-info">Manage Courses</a>
            </div>
            
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>Access and review student medical records.</p>
                <a href="#" class="btn btn-warning">View Medical Records</a>
            </div>
            
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>Generate time table for the entire school.</p>
                <a href="{% url 'generate_timetable' %}" class="btn btn-success">Generate timetable</a>
            </div>
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View timetable for your courses.</p>
                <a href="{% url 'view_timetable' %}" class="btn btn-info">View Timetable</a>
            </div>
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View all student results and academic performance.</p>
                <a href="{% url 'result_list' %}" class="btn btn-success">View All Results</a>
            </div>
            
            </div>

        </div>

    {% elif user.role == "LECTURER" %}
    {% if user.lecturer %}
        {% if user.lecturer.approved %}
          
          <!-- Lecturer Section -->
            <div class="dashboard-box">
                <h3 class="card-title"> Welcome, {{ request.user.username }} to Lecturer Dashboard</h3><hr>
                <div class = "d-flex">
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>View all the courses your ar to teach.</p>
                    <a href="{% url 'lecturer_courses' %}" class="btn btn-primary">View Courses</a>
                </div>
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>View all students who have registered for your courses.</p>
                    <a href="{% url 'lecturer_view_students' %}" class="btn btn-primary">View Registered Students</a>
                </div>
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>Input and manage grades for students in your courses.</p>
                    <a href="{% url 'lecturer_input_grades' %}" class="btn btn-secondary">Input Grades</a>
                </div>
                
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>View timetable for your courses.</p>
                    <a href="{% url 'lecturer_view_timetable' %}" class="btn btn-info">View Timetable</a>
                </div>
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>View and update your personal profile details.</p>
                    <a href="{% url 'lecturer_profile' %}" class="btn btn-warning">View Profile</a>
                </div>
                </div>
            </div>
            {% if user.lecturer.level.adviser %}
            <div class="dashboard-box">
                <h3 class="card-title">Level Advicer Panel</h3><hr>
                <div class = "d-flex">
                    <div  class="card" style="width: 18rem; padding: 20px;">
                        <p>View Approved Student in your level</p>
                        <a href="{% url 'level_adiviser_students' %}" class="btn btn-success" > View Approved Students</a>
                    </div>
                    <div  class="card" style="width: 18rem; padding: 20px;">
                        <p>Approve Student course registration</p>
                        <a href="{% url 'level_adiviser' %}" class="btn btn-success" > Approve Students</a>
                    </div>
                </div>
            </div>
            {% endif %}
            </div>
        {% else %}
            <h2>Your application is pending approval</h2>
        {% endif %}
        {% else %}
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

        <!-- Include Bootstrap JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateDepartmentModal">
            Update Department
        </button>
        <!-- Modal for updating Year of Study -->
        <div class="modal fade" id="updateDepartmentModal" tabindex="-1" aria-labelledby="updateDepartmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="updateDepartmentModalLabel">Update Department</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="DepartmentForm">
                            <div class="mb-3">
                                <label for="DepartmentInput" class="form-label">Department</label>
                                <select name="department" class="form-control" id="DepartmentInput" required>
                                    {% for department in department %}
                                      <option value="{{ department.id }}"> {{ department.name }} </option>
                                    {% endfor %}
                                    <option value=""></option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <script>
            // Submit the form via AJAX
            document.getElementById('DepartmentForm').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const update_department_val = document.getElementById('DepartmentInput').value;
                
                fetch("{% url 'update_department' %}", {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'department': update_department_val
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();  // Refresh the page to update year of study
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        </script>
    {% endif %}
    {% elif user.role == "STUDENT" %}
    {% if user.student %}
      {% if user.student.approved %}
            <!-- Student Section -->
        <div class="dashboard-box">
            <h3 class="card-title"> Welcome, {{ request.user.username }} to Student Dashboard</h3><hr>
            <div class = "d-flex">
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View your exam results and academic performance.</p>
                <a href="{% url 'result_list' %}" class="btn btn-primary">View Results</a>
            </div>
            
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View your personal timetable based on registered courses.</p>
                <a href="{% url 'student_view_timetable' %}" class="btn btn-info">View Timetable</a>
            </div>
                <div  class="card" style="width: 18rem; padding: 20px;">
                    <p>View and update your personal profile details.</p>
            <a href="{% url 'student_profile' %}" class="btn btn-warning">View Profile</a>
                </div>
            
            </div>
        </div>
        {% else %}
            <h2>Your application is pending approval by level adviser</h2>
      {% endif %}    
    {% else %}
      <!-- Include Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Include Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Modal for updating Year of Study -->
<div class="modal fade" id="updateYearModal" tabindex="-1" aria-labelledby="updateYearModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateYearModalLabel">Update Year of Study</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="yearOfStudyForm">
                    <!-- Department Dropdown -->
                    <div class="mb-3">
                        <label for="departmentSelect" class="form-label">Department</label>
                        <select class="form-select" id="departmentSelect" name="department" required>
                            <option value="">Select Department</option>
                            <!-- Dynamically populate departments here -->
                            {% for department in department %}
                                <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Level Dropdown (Populated based on Department selection) -->
                    <div class="mb-3">
                        <label for="levelSelect" class="form-label">Level</label>
                        <select class="form-select" id="levelSelect" name="level" required>
                            <option value="">Select Level</option>
                            <!-- Levels will be dynamically populated -->
                        </select>
                    </div>
                                  
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to fetch levels based on department
    document.getElementById('departmentSelect').addEventListener('change', function() {
        const departmentId = this.value;
        const levelSelect = document.getElementById('levelSelect');
        levelSelect.innerHTML = '<option value="">Select Level</option>';  // Clear previous levels

        if (departmentId) {
            fetch(`/get-levels/${departmentId}/`)
                .then(response => response.json())
                .then(data => {
                    data.levels.forEach(level => {
                        const option = document.createElement('option');
                        option.value = level.id;
                        option.textContent = level.level;
                        levelSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching levels:', error));
        }
    });

    // Submit the form via AJAX
    document.getElementById('yearOfStudyForm').addEventListener('submit', function(event) {
        event.preventDefault();
        
        const departmentId = document.getElementById('departmentSelect').value;
        const levelId = document.getElementById('levelSelect').value;

        fetch("{% url 'update_year_of_study' %}", {
            method: "POST",
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                'department': departmentId,
                'level': levelId,
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();  // Refresh the page to update year of study
            } else {
                alert(data.message);
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>

<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateYearModal">
    Update Year of Study
</button>

    {% endif %}
    {% elif is_clinic_staff %}
        <!-- Clinic Staff Section -->
        <div class="dashboard-box">
            <h3 class="card-title"> Welcome, {{ request.user.username }} to Clinic Staff Dashboard</h3><hr>
            <div class = "d-flex">
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>View student medical records to assist in treatment.</p>
                <a href="{% url 'view_student_medical_records' %}" class="btn btn-primary">View Student Medical Records</a>
            </div>
            
            <div  class="card" style="width: 18rem; padding: 20px;">
                <p>Update student medical records with new information.</p>
                <a href="{% url 'update_medical_records' %}" class="btn btn-secondary">Update Medical Records</a>
            </div>
        </div>
    {% endif %}
</div>
{% endif %} 
 
{% endblock %}
